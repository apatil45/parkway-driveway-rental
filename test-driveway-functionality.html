<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driveway Functionality Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
        }
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
        }
        .upload-area:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .file-input {
            display: none;
        }
        .slot-test {
            border: 1px solid #e5e7eb;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f9fafb;
        }
    </style>
</head>
<body>
    <h1>Driveway Functionality Test</h1>
    
    <div class="test-section">
        <h2>1. Image Upload Test</h2>
        <p>Test image upload functionality:</p>
        
        <div class="image-upload-section">
            <input
                type="file"
                accept="image/*"
                multiple
                id="image-upload-input"
                class="file-input"
            />
            <label for="image-upload-input" class="upload-area">
                <p>Click to upload photos or drag and drop</p>
                <p>Up to 5 images, max 5MB each</p>
            </label>
        </div>
        
        <div id="upload-result" class="result" style="display: none;"></div>
        <div id="uploaded-images"></div>
    </div>

    <div class="test-section">
        <h2>2. Specific Slot Adding Test</h2>
        <p>Test adding specific time slots:</p>
        
        <button class="test-button" onclick="addSpecificSlot()">Add Time Slot</button>
        <button class="test-button" onclick="clearSlots()">Clear All Slots</button>
        
        <div id="slots-container"></div>
        <div id="slot-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>3. Backend API Test</h2>
        <p>Test backend connectivity:</p>
        
        <button class="test-button" onclick="testUploadEndpoint()">Test Upload Endpoint</button>
        <button class="test-button" onclick="testDrivewayEndpoint()">Test Driveway Endpoint</button>
        
        <div id="api-result" class="result" style="display: none;"></div>
    </div>

    <script>
        let specificSlots = [];
        let uploadedImages = [];

        // Image upload functionality
        document.getElementById('image-upload-input').addEventListener('change', function(e) {
            if (e.target.files && e.target.files.length > 0) {
                handleImageUpload(e.target.files);
            }
        });

        // Drag and drop functionality
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageUpload(files);
            }
        });

        async function handleImageUpload(files) {
            const resultDiv = document.getElementById('upload-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = `Processing ${files.length} file(s)...`;

            try {
                const uploadPromises = Array.from(files).map(async (file) => {
                    // Validate file size (5MB max)
                    if (file.size > 5 * 1024 * 1024) {
                        throw new Error(`File ${file.name} is too large. Maximum size is 5MB.`);
                    }

                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        throw new Error(`File ${file.name} is not an image.`);
                    }

                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const response = await fetch('/api/upload/single', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token') || 'test-token'}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Upload failed');
                    }

                    const result = await response.json();
                    return result.imageUrl;
                });

                const uploadedUrls = await Promise.all(uploadPromises);
                uploadedImages.push(...uploadedUrls);

                resultDiv.className = 'result success';
                resultDiv.textContent = `Successfully uploaded ${uploadedUrls.length} image(s)!`;

                // Display uploaded images
                displayUploadedImages();

            } catch (error) {
                console.error('Image upload error:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `Upload failed: ${error.message}`;
            }
        }

        function displayUploadedImages() {
            const container = document.getElementById('uploaded-images');
            container.innerHTML = '<h3>Uploaded Images:</h3>';
            
            uploadedImages.forEach((url, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.style.margin = '10px 0';
                imgDiv.innerHTML = `
                    <img src="${url}" alt="Uploaded image ${index + 1}" style="max-width: 200px; max-height: 150px; border-radius: 8px;">
                    <button onclick="removeImage(${index})" style="margin-left: 10px; background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Remove</button>
                `;
                container.appendChild(imgDiv);
            });
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            displayUploadedImages();
        }

        // Specific slot functionality
        function addSpecificSlot() {
            const slot = {
                date: '',
                startTime: '08:00',
                endTime: '18:00',
                pricePerHour: 5
            };
            
            specificSlots.push(slot);
            displaySlots();
            
            const resultDiv = document.getElementById('slot-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';
            resultDiv.textContent = `Added slot ${specificSlots.length}. Total slots: ${specificSlots.length}`;
        }

        function removeSlot(index) {
            specificSlots.splice(index, 1);
            displaySlots();
            
            const resultDiv = document.getElementById('slot-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = `Removed slot. Total slots: ${specificSlots.length}`;
        }

        function clearSlots() {
            specificSlots = [];
            displaySlots();
            
            const resultDiv = document.getElementById('slot-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'All slots cleared.';
        }

        function displaySlots() {
            const container = document.getElementById('slots-container');
            container.innerHTML = '';
            
            if (specificSlots.length === 0) {
                container.innerHTML = '<p>No specific slots added yet.</p>';
                return;
            }
            
            specificSlots.forEach((slot, index) => {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'slot-test';
                slotDiv.innerHTML = `
                    <h4>Slot ${index + 1}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <label>Date:</label>
                            <input type="date" value="${slot.date}" onchange="updateSlot(${index}, 'date', this.value)" style="width: 100%; padding: 5px;">
                        </div>
                        <div>
                            <label>Start Time:</label>
                            <input type="time" value="${slot.startTime}" onchange="updateSlot(${index}, 'startTime', this.value)" style="width: 100%; padding: 5px;">
                        </div>
                        <div>
                            <label>End Time:</label>
                            <input type="time" value="${slot.endTime}" onchange="updateSlot(${index}, 'endTime', this.value)" style="width: 100%; padding: 5px;">
                        </div>
                        <div>
                            <label>Price/Hour:</label>
                            <input type="number" value="${slot.pricePerHour}" onchange="updateSlot(${index}, 'pricePerHour', this.value)" style="width: 100%; padding: 5px;">
                        </div>
                        <button onclick="removeSlot(${index})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Remove</button>
                    </div>
                `;
                container.appendChild(slotDiv);
            });
        }

        function updateSlot(index, field, value) {
            specificSlots[index][field] = field === 'pricePerHour' ? parseFloat(value) || 0 : value;
        }

        // API testing
        async function testUploadEndpoint() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'Testing upload endpoint...';

            try {
                const response = await fetch('/api/upload/test', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'test-token'}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `Upload endpoint working! Cloudinary configured: ${data.config.cloudinary.configured}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `Upload endpoint failed: ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Upload endpoint error: ${error.message}`;
            }
        }

        async function testDrivewayEndpoint() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'Testing driveway endpoint...';

            try {
                const response = await fetch('/api/driveways');

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `Driveway endpoint working! Found ${data.length} driveways.`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `Driveway endpoint failed: ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Driveway endpoint error: ${error.message}`;
            }
        }

        // Initialize display
        displaySlots();
    </script>
</body>
</html>
